name: Analysing operational characteristics for different JSON-based static data load and reload approaches
on:
  - push
  - workflow_dispatch
  
jobs:
  run_analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - run: |
          python -m venv venv
          source venv/bin/activate

          pip install -r requirements.txt

          python generate_dataset.py \
            --num_samples 1500000 \
            --num_recommendations 10 \
            --product_pool_size 10000

          ls -lh uncommitted/

      - uses: actions/upload-artifact@v4
        with:
          name: data_sample
          path: |
            uncommitted/recommendations_dataset.json
            uncommitted/recommendations_dataset.jsonl

  measure_performance:
    needs: run_analysis
    runs-on: ubuntu-slim # 5GB RAM
    strategy:
      matrix:
        script: [load_json.py, load_jsonl.py, load_pandas_json.py, load_pandas_jsonl.py]
    steps:
      - uses: actions/checkout@v3

      - uses: actions/download-artifact@v4
        with:
          name: data_sample
          path: uncommitted/

      - name: Run Analysis with vmstat monitoring
        continue-on-error: true
        run: |
          python -m venv venv
          source venv/bin/activate
          
          pip install -r requirements.txt

          # Start vmstat in the background
          # -n suppresses repeating headers
          # 1 is the delay in seconds
          vmstat -n 1 > vmstat_${{ matrix.script }}.log &
          VMSTAT_PID=$!
          echo "vmstat running with PID: $VMSTAT_PID"

          # Run the target script
          # We assume the script takes the appropriate file path as an argument 
          # or finds it in the expected location.
          if [[ "${{ matrix.script }}" == *"jsonl"* ]]; then
            DATA_FILE="uncommitted/recommendations_dataset.jsonl"
          else
            DATA_FILE="uncommitted/recommendations_dataset.json"
          fi

          time python ${{ matrix.script }} $DATA_FILE || true

          # Stop vmstat
          kill $VMSTAT_PID

      - uses: actions/upload-artifact@v4
        with:
          name: vmstat-results-${{ matrix.script }}
          path: vmstat_${{ matrix.script }}.log

  generate_summary:
    needs: measure_performance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/download-artifact@v4
        with:
          pattern: vmstat-results-*
          merge-multiple: true
          path: performance_data/

      - name: Generate Jupyter Notebook Summary
        run: |
          python -m venv venv
          source venv/bin/activate

          pip install -r requirements.txt

          ls -lart performance_data/

      # - uses: actions/upload-artifact@v4
      #   with:
      #     name: summary-notebook
      #     path: summary_analysis.ipynb
